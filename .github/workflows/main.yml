name: Watch and Build Ferrum (Java 21 Rollback)

on:
  schedule:
    - cron: '*/15 * * * *' # Перевірка кожні 15 хвилин
  workflow_dispatch:      # Кнопка для ручного запуску
  push:
    paths:
      - 'update'          # Примусовий білд при зміні цього файлу

jobs:
  check_and_build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Потрібно для роботи з історією комітів

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Clone and Find Stable Commit
        id: build_logic
        run: |
          git clone https://github.com/PlusMarden17/ferrum.git source
          cd source
          
          # Отримуємо список останніх 15 комітів
          COMMITS=$(git rev-list --max-count=15 HEAD)
          
          SUCCESS_SHA=""
          
          for SHA in $COMMITS; do
            echo "------------------------------------------------"
            echo "Checking commit: $SHA"
            
            # Очищуємо все перед переходом
            git reset --hard
            git checkout $SHA
            chmod +x gradlew
            
            # Спроба збірки (без тестів для швидкості)
            if ./gradlew clean assemble -x test --no-daemon; then
              echo "SUCCESS: Commit $SHA is stable!"
              SUCCESS_SHA=$SHA
              break
            else
              echo "FAILED: Commit $SHA is broken. Trying previous..."
            fi
          done
          
          if [ -z "$SUCCESS_SHA" ]; then
            echo "Error: None of the last 15 commits are buildable."
            exit 1
          fi
          
          echo "stable_sha=$SUCCESS_SHA" >> $GITHUB_OUTPUT
          
          # Зберігаємо готовий файл
          mkdir -p ../output
          cp build/libs/*.jar ../output/ferrum.jar

      - name: Check if Stable SHA is new
        id: check_new
        run: |
          STABLE="${{ steps.build_logic.outputs.stable_sha }}"
          if [ -f last_sha.txt ] && [ "$(cat last_sha.txt)" == "$STABLE" ] && [ "${{ github.event_name }}" != "push" ]; then
             echo "new_found=false" >> $GITHUB_OUTPUT
          else
             echo "new_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_new.outputs.new_found == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.build_logic.outputs.stable_sha }}-${{ github.run_number }}
          name: "Stable Build: ${{ steps.build_logic.outputs.stable_sha }}"
          body: |
            Автоматична збірка знайдена шляхом відкату до стабільного коміту.
            Оригінальний коміт: ${{ steps.build_logic.outputs.stable_sha }}
            Використано Java 21.
          files: output/ferrum.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update last_sha.txt in repo
        if: steps.check_new.outputs.new_found == 'true'
        run: |
          echo "${{ steps.build_logic.outputs.stable_sha }}" > last_sha.txt
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add last_sha.txt
          git commit -m "Update last stable SHA to ${{ steps.build_logic.outputs.stable_sha }} [skip ci]" || echo "No changes"
          git push
