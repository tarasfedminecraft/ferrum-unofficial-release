name: Watch and Build Ferrum (with Rollback)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'update'

jobs:
  check_and_build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Clone and Find Stable Commit
        id: build_logic
        run: |
          git clone https://github.com/PlusMarden17/ferrum.git source
          cd source
          chmod +x gradlew
          
          # Отримуємо список останніх 10 комітів
          COMMITS=$(git log -n 10 --format="%H")
          
          SUCCESS_SHA=""
          
          for SHA in $COMMITS; do
            echo "------------------------------------------------"
            echo "Checking commit: $SHA"
            git checkout $SHA
            
            # Спроба збірки
            if ./gradlew clean assemble; then
              echo "SUCCESS: Commit $SHA is stable!"
              SUCCESS_SHA=$SHA
              break
            else
              echo "FAILED: Commit $SHA is broken. Trying previous..."
            fi
          done
          
          if [ -z "$SUCCESS_SHA" ]; then
            echo "Error: None of the last 10 commits are buildable."
            exit 1
          fi
          
          echo "stable_sha=$SUCCESS_SHA" >> $GITHUB_OUTPUT
          # Копіюємо JAR для наступних кроків
          mkdir -p ../output
          cp build/libs/*.jar ../output/ferrum.jar

      - name: Check if Stable SHA is new
        id: check_new
        run: |
          STABLE="${{ steps.build_logic.outputs.stable_sha }}"
          if [ -f last_sha.txt ] && [ "$(cat last_sha.txt)" == "$STABLE" ] && [ "${{ github.event_name }}" != "push" ]; then
             echo "new_found=false" >> $GITHUB_OUTPUT
          else
             echo "new_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_new.outputs.new_found == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.build_logic.outputs.stable_sha }}-${{ github.run_number }}
          name: "Stable Build: ${{ steps.build_logic.outputs.stable_sha }}"
          body: "Ця збірка знайдена автоматичним перебором останніх комітів до першого стабільного."
          files: output/ferrum.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update last_sha.txt
        if: steps.check_new.outputs.new_found == 'true'
        run: |
          echo "${{ steps.build_logic.outputs.stable_sha }}" > last_sha.txt
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add last_sha.txt
          git commit -m "Update last stable SHA to ${{ steps.build_logic.outputs.stable_sha }} [skip ci]" || echo "No changes"
          git push
