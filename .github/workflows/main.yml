name: Watch and Build Ferrum

on:
  schedule:
    - cron: '*/15 * * * *' # Перевірка кожні 15 хвилин
  workflow_dispatch:      # Кнопка для ручного запуску
  push:
    paths:
      - 'update'          # Примусовий білд при зміні цього файлу

jobs:
  check_and_build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Get Latest Commit SHA from Ferrum
        id: get_sha
        run: |
          SHA=$(curl -s https://api.github.com/repos/PlusMarden17/ferrum/commits/master | jq -r '.sha')
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Check Status (New Commit or Forced)
        id: check_status
        run: |
          # Перевіряємо, чи запуск викликаний зміною файлу 'update'
          if [[ "${{ github.event_name }}" == "push" && "${{ github.event.head_commit.message }}" == *"update"* ]]; then
             echo "forced=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]]; then
             # Будь-який пуш у файл 'update'
             echo "forced=true" >> $GITHUB_OUTPUT
          else
             echo "forced=false" >> $GITHUB_OUTPUT
          fi
          
          # Перевіряємо старий SHA
          if [ -f last_sha.txt ] && [ "$(cat last_sha.txt)" == "${{ steps.get_sha.outputs.sha }}" ]; then
             echo "match=true" >> $GITHUB_OUTPUT
          else
             echo "match=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if no new changes
        # Виходимо тільки якщо SHA співпадає І це НЕ примусовий запуск через файл 'update'
        if: steps.check_status.outputs.match == 'true' && steps.check_status.outputs.forced == 'false'
        run: |
          echo "No new commits found and not forced. Skipping build."
          exit 0

      - name: Clone Original Ferrum
        run: git clone https://github.com/PlusMarden17/ferrum.git source

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Ferrum
        run: |
          cd source
          chmod +x gradlew
          ./gradlew build

      - name: Rename JAR for consistency
        run: mv source/build/libs/*.jar source/build/libs/ferrum.jar

      - name: Create Release and Upload JAR
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_sha.outputs.sha }}-${{ github.run_number }}
          name: "Build: ${{ steps.get_sha.outputs.sha }}"
          body: |
            Автоматична збірка бібліотеки Ferrum.
            Коміт: ${{ steps.get_sha.outputs.sha }}
            Тип запуску: ${{ steps.check_status.outputs.forced == 'true' && 'Примусовий (update)' || 'Автоматичний' }}
          files: source/build/libs/ferrum.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update last_sha.txt in repo
        run: |
          echo "${{ steps.get_sha.outputs.sha }}" > last_sha.txt
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add last_sha.txt
          git commit -m "Update last built SHA to ${{ steps.get_sha.outputs.sha }} [skip ci]" || echo "No changes to commit"
          git push
